<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Produkt Foto + JSON Generator</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      max-width: 900px;
    }
    h1 {
      margin-bottom: 0.5rem;
    }
    section {
      margin-top: 1.5rem;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    #video, #photoPreview {
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .field {
      margin-bottom: 0.75rem;
      min-width: 200px;
      flex: 1;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    input[type="text"],
    textarea,
    input[type="number"] {
      width: 100%;
      padding: 0.4rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea {
      font-family: "JetBrains Mono", "Fira Code", monospace;
    }
    button {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      border: 1px solid #333;
      background: #333;
      color: #fff;
      cursor: pointer;
      margin-right: 0.5rem;
      margin-top: 0.5rem;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    small {
      display: block;
      color: #555;
      margin-top: 0.25rem;
    }
  </style>
</head>
<body>
  <h1>Produkt-Foto aufnehmen & JSON erzeugen</h1>
  <p>
    1. Kamera starten → Foto aufnehmen → Foto speichern.<br />
    2. Produktdaten ausfüllen → JSON erzeugen → JSON speichern.<br />
    <strong>image_url</strong> wird automatisch auf den Foto-Dateinamen gesetzt.
  </p>

  <!-- Kamera / Foto -->
  <section>
    <h2>Kamera & Foto</h2>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <div>
      <button id="startCamBtn">Kamera starten</button>
      <button id="captureBtn" disabled>Foto aufnehmen</button>
      <button id="downloadPhotoBtn" disabled>Foto speichern</button>
    </div>
    <small>
      Hinweis: Der Browser fragt nach Kamerazugriff. Beim Speichern bestimmst du selbst den Zielordner auf deinem Rechner.
    </small>
    <h3>Vorschau</h3>
    <img id="photoPreview" alt="Aufgenommenes Foto" />
  </section>

  <!-- Produktformular -->
  <section>
    <h2>Produktdaten</h2>
    <form id="productForm" onsubmit="return false;">
      <div class="row">
        <div class="field">
          <label for="sku">SKU</label>
          <input type="text" id="sku" placeholder="z.B. HERR-SHIRT-BLAU-001" />
        </div>
        <div class="field">
          <label for="name">Name</label>
          <input type="text" id="name" placeholder="Athletisches Herren-T-Shirt" />
        </div>
      </div>

      <div class="field">
        <label for="description">Beschreibung</label>
        <textarea id="description" rows="3" placeholder="Ein atmungsaktives T-Shirt für maximale Leistung."></textarea>
      </div>

      <div class="row">
        <div class="field">
          <label for="category">Kategorie</label>
          <input type="text" id="category" placeholder="Herren, Damen, Unisex, Zubehör ..." />
        </div>
        <div class="field">
          <label for="subcategory">Subkategorie</label>
          <input type="text" id="subcategory" placeholder="Sportbekleidung, Schuhe, Zubehör ..." />
        </div>
        <div class="field">
          <label for="type">Typ</label>
          <input type="text" id="type" placeholder="T-Shirt, Hose, Schuhe ..." />
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="material">Material</label>
          <input type="text" id="material" placeholder="Polyester, Baumwolle-Elasthan, ..." />
        </div>
        <div class="field">
          <label for="colors">Farben (durch Komma getrennt)</label>
          <input type="text" id="colors" placeholder="Blau, Schwarz, Grau" />
        </div>
        <div class="field">
          <label for="sizes">Größen (durch Komma getrennt)</label>
          <input type="text" id="sizes" placeholder="S, M, L, XL" />
        </div>
      </div>

      <div class="field">
        <label for="stock">Stock (size:menge, eine pro Zeile)</label>
        <textarea id="stock" rows="4" placeholder="S:10&#10;M:15&#10;L:12&#10;XL:5"></textarea>
        <small>Beispiel: jede Zeile im Format <code>Größe:Menge</code></small>
      </div>

      <div class="field">
        <label for="imageUrl">image_url (Dateiname oder URL)</label>
        <input type="text" id="imageUrl" placeholder="wird nach Fotoaufnahme automatisch gesetzt" />
        <small>Nach dem Foto z.B. <code>HERR-SHIRT-BLAU-001.png</code> oder ein kompletter URL.</small>
      </div>

      <div>
        <button id="generateJsonBtn">JSON erzeugen</button>
        <button id="downloadJsonBtn" disabled>JSON speichern</button>
      </div>
    </form>
  </section>

  <!-- JSON Ausgabe -->
  <section>
    <h2>JSON Vorschau</h2>
    <textarea id="jsonOutput" rows="18" readonly></textarea>
  </section>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startCamBtn = document.getElementById('startCamBtn');
    const captureBtn = document.getElementById('captureBtn');
    const downloadPhotoBtn = document.getElementById('downloadPhotoBtn');
    const photoPreview = document.getElementById('photoPreview');

    const skuInput = document.getElementById('sku');
    const imageUrlInput = document.getElementById('imageUrl');
    const generateJsonBtn = document.getElementById('generateJsonBtn');
    const downloadJsonBtn = document.getElementById('downloadJsonBtn');
    const jsonOutput = document.getElementById('jsonOutput');

    let mediaStream = null;
    let capturedImageBlob = null;
    let capturedImageFilename = null;

    // Kamera starten
    startCamBtn.addEventListener('click', async () => {
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = mediaStream;
        captureBtn.disabled = false;
      } catch (err) {
        alert('Kamera konnte nicht gestartet werden: ' + err.message);
      }
    });

    // Foto aufnehmen
    captureBtn.addEventListener('click', () => {
      if (!mediaStream) return;

      const videoTrack = mediaStream.getVideoTracks()[0];
      const settings = videoTrack.getSettings();
      const width = settings.width || 640;
      const height = settings.height || 480;

      canvas.width = width;
      canvas.height = height;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, width, height);

      canvas.toBlob((blob) => {
        if (!blob) {
          alert('Fehler beim Erzeugen des Bildes.');
          return;
        }
        capturedImageBlob = blob;

        // Dateiname aus SKU oder Fallback
        const skuVal = (skuInput.value || 'produkt-foto').trim().replace(/\s+/g, '-');
        capturedImageFilename = skuVal + '.png';

        // Vorschau anzeigen
        const url = URL.createObjectURL(blob);
        photoPreview.src = url;

        // image_url Feld automatisch setzen, damit JSON dazu passt
        imageUrlInput.value = capturedImageFilename;

        downloadPhotoBtn.disabled = false;
        alert('Foto aufgenommen! Jetzt kannst du es speichern.');
      }, 'image/png');
    });

    // Foto speichern (Download)
    downloadPhotoBtn.addEventListener('click', () => {
      if (!capturedImageBlob || !capturedImageFilename) {
        alert('Bitte zuerst ein Foto aufnehmen.');
        return;
      }

      const a = document.createElement('a');
      const url = URL.createObjectURL(capturedImageBlob);
      a.href = url;
      a.download = capturedImageFilename; // Browser fragt nach Ordner / Speicherort
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Hilfsfunktion: Stock-String -> Objekt
    function parseStock(stockText) {
      const stock = {};
      const lines = stockText.split('\n');
      for (const line of lines) {
        const trimmed = line.trim();
        if (!trimmed) continue;
        const parts = trimmed.split(':');
        if (parts.length < 2) continue;
        const size = parts[0].trim();
        const qty = parseInt(parts[1].trim(), 10);
        stock[size] = isNaN(qty) ? parts[1].trim() : qty;
      }
      return stock;
    }

    // JSON erzeugen
    generateJsonBtn.addEventListener('click', () => {
      const product = {
        sku: skuInput.value.trim(),
        name: document.getElementById('name').value.trim(),
        description: document.getElementById('description').value.trim(),
        category: document.getElementById('category').value.trim(),
        subcategory: document.getElementById('subcategory').value.trim(),
        type: document.getElementById('type').value.trim(),
        material: document.getElementById('material').value.trim(),
        colors: document.getElementById('colors').value
          .split(',')
          .map(c => c.trim())
          .filter(c => c.length > 0),
        sizes: document.getElementById('sizes').value
          .split(',')
          .map(s => s.trim())
          .filter(s => s.length > 0),
        stock: parseStock(document.getElementById('stock').value),
        image_url: imageUrlInput.value.trim()
      };

      // Wrap in Array wie in deinem Beispiel
      const jsonArray = [product];
      const jsonString = JSON.stringify(jsonArray, null, 2);
      jsonOutput.value = jsonString;
      downloadJsonBtn.disabled = false;
    });

    // JSON speichern (Download)
    downloadJsonBtn.addEventListener('click', () => {
      if (!jsonOutput.value.trim()) {
        alert('Bitte zuerst JSON erzeugen.');
        return;
      }

      const skuVal = (skuInput.value || 'produkt').trim().replace(/\s+/g, '-');
      const filename = skuVal + '.json';
      const blob = new Blob([jsonOutput.value], { type: 'application/json' });

      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
