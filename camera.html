<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Einfache Produkt-App (Foto + JSON)</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      max-width: 900px;
    }
    h1 {
      margin-bottom: 0.5rem;
    }
    section {
      margin-top: 1.5rem;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    #video, #photoPreview {
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .field {
      margin-bottom: 0.75rem;
      min-width: 200px;
      flex: 1;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    select,
    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 0.4rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea {
      font-family: "JetBrains Mono", "Fira Code", monospace;
    }
    button {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      border: 1px solid #333;
      background: #333;
      color: #fff;
      cursor: pointer;
      margin-right: 0.5rem;
      margin-top: 0.5rem;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    small {
      display: block;
      color: #555;
      margin-top: 0.25rem;
    }
  </style>
</head>
<body>
  <h1>Produkt-Foto aufnehmen & JSON erzeugen (einfach)</h1>
  <p>
    1. Kategorie & Artikeltyp auswählen, Menge eintragen.<br />
    2. Kamera starten → Foto aufnehmen → Foto speichern.<br />
    3. JSON erzeugen → JSON speichern.<br />
    Alle Detailfelder (Name, Beschreibung, etc.) werden automatisch aus Vorlagen erzeugt.
  </p>

  <!-- Kamera / Foto -->
  <section>
    <h2>Kamera & Foto</h2>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <div>
      <button id="startCamBtn">Kamera starten</button>
      <button id="captureBtn" disabled>Foto aufnehmen</button>
      <button id="downloadPhotoBtn" disabled>Foto speichern</button>
    </div>
    <small>
      Hinweis: Der Browser fragt nach Kamerazugriff. Beim Speichern bestimmst du selbst den Zielordner auf deinem Rechner.
    </small>
    <h3>Vorschau</h3>
    <img id="photoPreview" alt="Aufgenommenes Foto" />
  </section>

  <!-- Produkt-Auswahl (DROPDOWN) -->
  <section>
    <h2>Produkt-Auswahl</h2>
    <div class="row">
      <div class="field">
        <label for="categorySelect">Kategorie</label>
        <select id="categorySelect">
          <option value="">Bitte wählen ...</option>
          <option value="Accessoires & Ausrüstung">Accessoires &amp; Ausrüstung</option>
          <option value="Bekleidung">Bekleidung</option>
        </select>
      </div>

      <div class="field">
        <label for="itemTypeSelect">Artikeltyp</label>
        <select id="itemTypeSelect" disabled>
          <option value="">Bitte zuerst Kategorie wählen ...</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label for="quantityInput">Menge im Lager</label>
        <input type="number" id="quantityInput" min="0" step="1" placeholder="z.B. 84" />
        <small>Nur eine Gesamtmenge, intern wird <code>OneSize</code> verwendet.</small>
      </div>

      <div class="field">
        <label for="skuInput">SKU</label>
        <input type="text" id="skuInput" placeholder="wird automatisch erzeugt" />
        <small>Wird aus Kategorie + Artikeltyp erzeugt, kann aber überschrieben werden.</small>
      </div>
    </div>

    <div class="field">
      <label for="imageUrlInput">image_url</label>
      <input type="text" id="imageUrlInput" placeholder="wird nach Fotoaufnahme auf &lt;SKU&gt;.png gesetzt" />
      <small>Nach Fotoaufnahme automatisch gefüllt (Dateiname). Du kannst den Pfad/URL anpassen.</small>
    </div>

    <div>
      <button id="generateJsonBtn">JSON erzeugen</button>
      <button id="downloadJsonBtn" disabled>JSON speichern</button>
    </div>
  </section>

  <!-- JSON Ausgabe -->
  <section>
    <h2>JSON Vorschau</h2>
    <textarea id="jsonOutput" rows="18" readonly></textarea>
  </section>

  <script>
    /********** Produkt-Vorlagen (Templates) **********/
    // Du kannst diese Texte gerne anpassen/erweitern.
    const productTemplates = {
      "Accessoires & Ausrüstung": {
        "Socken": {
          name: "Sportsocken",
          description: "Bequeme Sportsocken mit guter Dämpfung.",
          subcategory: "Accessoires",
          type: "Socken",
          material: "Baumwolle-Polyester",
          colors: ["Schwarz", "Weiß"],
        },
        "Handschuhe": {
          name: "Sporthandschuhe",
          description: "Handschuhe mit Grip für Training und Outdoor.",
          subcategory: "Accessoires",
          type: "Handschuhe",
          material: "Synthetik",
          colors: ["Schwarz"],
        },
        "Mütze/Schal": {
          name: "Mütze / Schal",
          description: "Warme Mütze oder Schal für Outdoor-Sport.",
          subcategory: "Accessoires",
          type: "Mütze/Schal",
          material: "Acryl",
          colors: ["Schwarz", "Grau"],
        },
        "Handyhalter": {
          name: "Handyhalter",
          description: "Handyhalter für den Arm beim Laufen.",
          subcategory: "Ausrüstung",
          type: "Handyhalter",
          material: "Neopren",
          colors: ["Schwarz"],
        },
        "Karategürtel": {
          name: "Karategürtel",
          description: "Robuster Gürtel für Karate und andere Kampfsportarten.",
          subcategory: "Ausrüstung",
          type: "Karategürtel",
          material: "Baumwolle",
          colors: ["Weiß", "Gelb", "Orange", "Grün", "Blau", "Braun", "Schwarz"],
        },
        "Taschen": {
          name: "Sporttasche",
          description: "Geräumige Tasche für Sportausrüstung.",
          subcategory: "Ausrüstung",
          type: "Tasche",
          material: "Polyester",
          colors: ["Schwarz", "Blau"],
        },
        "Judo": {
          name: "Judo-Ausrüstung",
          description: "Zubehör für Judo-Training und Wettkampf.",
          subcategory: "Ausrüstung",
          type: "Judo",
          material: "Mischgewebe",
          colors: ["Weiß"],
        },
        "Cappy": {
          name: "Cap",
          description: "Leichte Cap zum Sport oder Alltag.",
          subcategory: "Accessoires",
          type: "Cap",
          material: "Baumwolle",
          colors: ["Schwarz", "Navy"],
        }
      },
      "Bekleidung": {
        "Schuhe": {
          name: "Sportschuhe",
          description: "Leichte, bequeme Sportschuhe für Training und Alltag.",
          subcategory: "Schuhe",
          type: "Schuhe",
          material: "Synthetik",
          colors: ["Schwarz", "Weiß"],
        },
        "Gymnastik (Tops & Leggings)": {
          name: "Gymnastik-Outfit",
          description: "Set aus Gymnastik-Top und Leggings.",
          subcategory: "Gymnastik",
          type: "Tops & Leggings",
          material: "Elasthan-Mischung",
          colors: ["Schwarz", "Lila", "Blau"],
        },
        "Leibchen": {
          name: "Leibchen",
          description: "Standard-Leibchen für Training und Teamsport.",
          subcategory: "Oberteile",
          type: "Leibchen",
          material: "Polyester",
          colors: ["Gelb", "Rot", "Blau"],
        },
        "Oberteile": {
          name: "Sport-Oberteil",
          description: "Oberteil für verschiedene Sportarten.",
          subcategory: "Oberteile",
          type: "Oberteil",
          material: "Polyester",
          colors: ["Schwarz", "Blau", "Rot"],
        },
        "Unterteile": {
          name: "Sport-Unterteil",
          description: "Bequeme Hose/Shorts für Sport und Training.",
          subcategory: "Unterteile",
          type: "Unterteil",
          material: "Polyester",
          colors: ["Schwarz", "Navy"],
        },
        "Sport-BHs": {
          name: "Sport-BH",
          description: "Stützender Sport-BH für Training und Alltag.",
          subcategory: "Unterwäsche",
          type: "Sport-BH",
          material: "Elasthan-Mischung",
          colors: ["Schwarz", "Grau"],
        },
        "Badeanzüge": {
          name: "Badeanzug",
          description: "Sportlicher Badeanzug für Schwimmtraining.",
          subcategory: "Schwimmen",
          type: "Badeanzug",
          material: "Polyamid-Elasthan",
          colors: ["Blau", "Schwarz"],
        },
        "Bikini": {
          name: "Bikini",
          description: "Sportlicher Bikini für Strand und Schwimmbad.",
          subcategory: "Schwimmen",
          type: "Bikini",
          material: "Polyamid-Elasthan",
          colors: ["Bunt", "Schwarz"],
        }
      }
    };

    const categorySelect = document.getElementById('categorySelect');
    const itemTypeSelect = document.getElementById('itemTypeSelect');
    const quantityInput = document.getElementById('quantityInput');
    const skuInput = document.getElementById('skuInput');
    const imageUrlInput = document.getElementById('imageUrlInput');
    const jsonOutput = document.getElementById('jsonOutput');
    const generateJsonBtn = document.getElementById('generateJsonBtn');
    const downloadJsonBtn = document.getElementById('downloadJsonBtn');

    let skuDirty = false; // ob Nutzer SKU manuell geändert hat

    function populateItemTypes(category) {
      itemTypeSelect.innerHTML = '';
      if (!category || !productTemplates[category]) {
        itemTypeSelect.disabled = true;
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Bitte zuerst Kategorie wählen ...';
        itemTypeSelect.appendChild(opt);
        return;
      }
      itemTypeSelect.disabled = false;
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Bitte Artikeltyp wählen ...';
      itemTypeSelect.appendChild(placeholder);

      const types = Object.keys(productTemplates[category]);
      types.forEach(typeName => {
        const opt = document.createElement('option');
        opt.value = typeName;
        opt.textContent = typeName;
        itemTypeSelect.appendChild(opt);
      });
    }

    function generateSku(category, itemType) {
      const prefixMap = {
        "Accessoires & Ausrüstung": "ACC",
        "Bekleidung": "BEK"
      };
      const prefix = prefixMap[category] || "GEN";
      const typePart = (itemType || "PROD")
        .toUpperCase()
        .replace(/Ä/g, "AE")
        .replace(/Ö/g, "OE")
        .replace(/Ü/g, "UE")
        .replace(/ß/g, "SS")
        .replace(/[^A-Z0-9]+/g, '-');
      const random = Math.floor(100 + Math.random() * 900);
      return `${prefix}-${typePart}-${random}`;
    }

    categorySelect.addEventListener('change', () => {
      populateItemTypes(categorySelect.value);
      if (!skuDirty && categorySelect.value) {
        skuInput.value = generateSku(categorySelect.value, itemTypeSelect.value || "PROD");
      }
    });

    itemTypeSelect.addEventListener('change', () => {
      if (!skuDirty && categorySelect.value && itemTypeSelect.value) {
        skuInput.value = generateSku(categorySelect.value, itemTypeSelect.value);
      }
    });

    skuInput.addEventListener('input', () => {
      skuDirty = skuInput.value.trim().length > 0;
    });

    /********** Kamera-Logik **********/
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startCamBtn = document.getElementById('startCamBtn');
    const captureBtn = document.getElementById('captureBtn');
    const downloadPhotoBtn = document.getElementById('downloadPhotoBtn');
    const photoPreview = document.getElementById('photoPreview');

    let mediaStream = null;
    let capturedImageBlob = null;
    let capturedImageFilename = null;

    // Kamera starten
    startCamBtn.addEventListener('click', async () => {
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = mediaStream;
        captureBtn.disabled = false;
      } catch (err) {
        alert('Kamera konnte nicht gestartet werden: ' + err.message);
      }
    });

    // Foto aufnehmen
    captureBtn.addEventListener('click', () => {
      if (!mediaStream) return;

      const videoTrack = mediaStream.getVideoTracks()[0];
      const settings = videoTrack.getSettings();
      const width = settings.width || 640;
      const height = settings.height || 480;

      canvas.width = width;
      canvas.height = height;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, width, height);

      canvas.toBlob((blob) => {
        if (!blob) {
          alert('Fehler beim Erzeugen des Bildes.');
          return;
        }
        capturedImageBlob = blob;

        // Dateiname aus SKU oder Fallback
        const skuVal = (skuInput.value || 'produkt-foto').trim().replace(/\s+/g, '-');
        capturedImageFilename = skuVal + '.png';

        const url = URL.createObjectURL(blob);
        photoPreview.src = url;

        // image_url Feld automatisch setzen, damit JSON dazu passt
        imageUrlInput.value = capturedImageFilename;

        downloadPhotoBtn.disabled = false;
        alert('Foto aufgenommen! Jetzt kannst du es speichern.');
      }, 'image/png');
    });

    // Foto speichern
    downloadPhotoBtn.addEventListener('click', () => {
      if (!capturedImageBlob || !capturedImageFilename) {
        alert('Bitte zuerst ein Foto aufnehmen.');
        return;
      }

      const a = document.createElement('a');
      const url = URL.createObjectURL(capturedImageBlob);
      a.href = url;
      a.download = capturedImageFilename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    /********** JSON-Erzeugung **********/
    generateJsonBtn.addEventListener('click', () => {
      const category = categorySelect.value;
      const itemType = itemTypeSelect.value;

      if (!category) {
        alert('Bitte eine Kategorie wählen.');
        return;
      }
      if (!itemType) {
        alert('Bitte einen Artikeltyp wählen.');
        return;
      }

      const qty = parseInt(quantityInput.value, 10) || 0;
      const sku = skuInput.value.trim() || generateSku(category, itemType);

      // image_url: wenn leer, auf <SKU>.png setzen
      let imageUrl = imageUrlInput.value.trim();
      if (!imageUrl) {
        imageUrl = sku.replace(/\s+/g, '-') + '.png';
        imageUrlInput.value = imageUrl;
      }

      const template = productTemplates[category][itemType] || {
        name: itemType,
        description: "",
        subcategory: category,
        type: itemType,
        material: "",
        colors: []
      };

      const product = {
        sku: sku,
        name: template.name,
        description: template.description,
        category: category,
        subcategory: template.subcategory,
        type: template.type,
        material: template.material,
        colors: template.colors,
        sizes: ["OneSize"],
        stock: {
          "OneSize": qty
        },
        image_url: imageUrl
      };

      const jsonArray = [product];
      jsonOutput.value = JSON.stringify(jsonArray, null, 2);
      downloadJsonBtn.disabled = false;
    });

    // JSON speichern
    downloadJsonBtn.addEventListener('click', () => {
      if (!jsonOutput.value.trim()) {
        alert('Bitte zuerst JSON erzeugen.');
        return;
      }

      const skuVal = (skuInput.value || 'produkt').trim().replace(/\s+/g, '-');
      const filename = skuVal + '.json';
      const blob = new Blob([jsonOutput.value], { type: 'application/json' });

      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
