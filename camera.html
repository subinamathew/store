<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Product Photo & JSON / Produkt-Foto & JSON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --primary: #1f2933;
      --primary-text: #ffffff;
      --border: #d0d7de;
      --bg-soft: #f7f9fb;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 12px;
      background: var(--bg-soft);
    }

    main {
      max-width: 900px;
      margin: 0 auto 40px;
    }

    h1 {
      margin: 0 0 0.25rem;
      font-size: 1.4rem;
      text-align: center;
    }

    p.lead {
      margin: 0 0 1rem;
      font-size: 0.9rem;
      text-align: center;
      color: #4b5563;
    }

    section {
      margin-top: 1rem;
      padding: 1rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #ffffff;
      box-shadow: 0 2px 4px rgba(15, 23, 42, 0.06);
    }

    h2 {
      margin-top: 0;
      font-size: 1.1rem;
    }

    #video, #photoPreview {
      width: 100%;
      max-height: 280px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      object-fit: cover;
      background: #000;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .row {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .field {
      margin-bottom: 0.75rem;
      flex: 1 1 100%;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
    }

    select,
    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 0.6rem 0.7rem;
      border-radius: 8px;
      border: 1px solid #d0d7de;
      font-size: 1rem;
      background: #f9fafb;
    }

    textarea {
      font-family: "JetBrains Mono", "Fira Code", monospace;
      resize: vertical;
    }

    button {
      padding: 0.8rem 1rem;
      border-radius: 999px;
      border: none;
      background: var(--primary);
      color: var(--primary-text);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      width: 100%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
    }

    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    small {
      display: block;
      color: #6b7280;
      margin-top: 0.25rem;
      font-size: 0.75rem;
    }

    #jsonOutput {
      width: 100%;
      padding: 0.6rem 0.7rem;
      border-radius: 8px;
      border: 1px solid #d0d7de;
      font-size: 0.8rem;
      background: #0b1020;
      color: #e5e7eb;
      min-height: 220px;
    }

    .top-controls {
      display: flex;
      gap: 0.75rem;
      margin: 0 0 0.75rem;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    .top-controls button {
      flex: 1 1 48%;
    }

    .color-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.3rem;
    }

    .color-btn {
      padding: 0.4rem 0.7rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f3f4f6;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      color: #111827;
    }

    .hidden {
      display: none;
    }

    @media (min-width: 640px) {
      .row .field {
        flex: 1 1 calc(50% - 0.5rem);
      }

      button {
        width: auto;
      }

      .controls {
        flex-direction: row;
        justify-content: space-between;
      }

      .controls button {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <main>
    <!-- Top Back + Refresh -->
    <div class="top-controls">
      <button id="backBtn" class="secondary">‚¨Ö Back / Zur√ºck</button>
      <button id="refreshBtn">üîÑ Refresh / Neu laden</button>
    </div>

    <h1>Product Photo & JSON / Produkt-Foto & JSON</h1>
    <p class="lead">
      Start camera once, select item type, set quantity, size & colours, then hold the item in front
      of the camera and tap ‚ÄúSave all‚Äù. The app auto-jumps to the next item type.<br />
      Kamera einmal starten, Artikeltyp w√§hlen, Menge, Gr√∂√üe & Farben setzen, Artikel vor die Kamera halten
      und ‚ÄûAlles speichern‚Äú tippen. Die App springt automatisch zum n√§chsten Artikeltyp.<br />
      <strong>Photo file name / Bildname = SKU.png, image_url = SKU.png</strong>
    </p>

    <!-- Camera / Foto -->
    <section>
      <h2>Camera & Photo / Kamera & Foto</h2>
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas" style="display:none;"></canvas>
      <div class="controls">
        <button id="startCamBtn">üì∑ Start back camera / Kamera (R√ºckseite) starten</button>
        <button id="captureBtn" disabled>üì∏ Preview only / Nur Vorschau-Foto</button>
      </div>
      <small>
        Tip: On mobile use HTTPS so the browser allows the camera.<br />
        Tipp: Auf dem Smartphone am besten √ºber HTTPS √∂ffnen, sonst blocken manche Browser die Kamera.
      </small>
      <h3 style="margin-top: 0.9rem; font-size: 0.95rem;">Preview / Vorschau</h3>
      <img id="photoPreview" alt="Captured photo / Aufgenommenes Foto" />
    </section>

    <!-- Product selection -->
    <section>
      <h2>Product selection / Produktauswahl</h2>
      <div class="row">
        <div class="field">
          <label for="categorySelect">Category / Kategorie</label>
          <select id="categorySelect">
            <option value="">Please choose ... / Bitte w√§hlen ...</option>
            <option value="Accessoires & Ausr√ºstung">Accessories & Equipment / Accessoires &amp; Ausr√ºstung</option>
            <option value="Bekleidung">Clothing / Bekleidung</option>
          </select>
        </div>

        <div class="field">
          <label for="itemTypeSelect">Item type / Artikeltyp</label>
          <select id="itemTypeSelect" disabled>
            <option value="">Choose category first / Bitte zuerst Kategorie w√§hlen ...</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="quantityInput">Stock quantity / Menge im Lager</label>
          <input type="number" id="quantityInput" min="0" step="1" placeholder="e.g. 120 / z.B. 120" />
          <small>
            Pre-filled with expected value, change if needed. Stored as <code>OneSize</code>.<br />
            Mit erwarteter Menge vorbelegt, bei Bedarf anpassen. Intern als <code>OneSize</code> gespeichert.
          </small>
        </div>

        <div class="field">
          <label for="sizeInput">Size / Gr√∂√üe</label>
          <input type="text" id="sizeInput" placeholder="e.g. 42 (EU), 38 (EU), M, OneSize" />
          <small>
            Used to fill the <code>sizes</code> array in JSON (single value, e.g. EU size).<br />
            Wird f√ºr das <code>sizes</code>-Array im JSON verwendet (ein Wert, z.B. EU-Gr√∂√üe).
          </small>
        </div>
      </div>

      <!-- Hidden SKU + image_url (still used internally) -->
      <div class="field hidden">
        <label for="skuInput">SKU</label>
        <input type="text" id="skuInput" />
      </div>

      <div class="field hidden">
        <label for="imageUrlInput">image_url</label>
        <input type="text" id="imageUrlInput" />
      </div>

      <div class="field">
        <label>Colours / Farben (multi-select)</label>
        <div id="colorButtonsContainer" class="color-buttons"></div>
        <small>
          Tap to select one or more colours. If none selected, template colours are used.<br />
          Tippe, um eine oder mehrere Farben zu w√§hlen. Ohne Auswahl werden die Standardfarben verwendet.
        </small>
      </div>

      <div class="controls">
        <button id="saveAllBtn">üíæ Save all (Photo + JSON) / Alles speichern (Foto + JSON)</button>
      </div>
    </section>

    <!-- JSON output (hidden) -->
    <section id="jsonSection" class="hidden">
      <h2>JSON preview / JSON-Vorschau</h2>
      <textarea id="jsonOutput" rows="16" readonly></textarea>
    </section>
  </main>

  <script>
    /********** Colour options: rainbow (VIGBYOR) + grey/white/black **********/
    const colorOptions = [
      { id: "violet", label: "Violett / Violet", css: "#8b5cf6" },
      { id: "indigo", label: "Indigo", css: "#4b0082" },
      { id: "blue", label: "Blau / Blue", css: "#3b82f6" },
      { id: "green", label: "Gr√ºn / Green", css: "#22c55e" },
      { id: "yellow", label: "Gelb / Yellow", css: "#eab308" },
      { id: "orange", label: "Orange", css: "#f97316" },
      { id: "red", label: "Rot / Red", css: "#ef4444" },
      { id: "gray", label: "Grau / Grey", css: "#6b7280" },
      { id: "white", label: "Wei√ü / White", css: "#ffffff" },
      { id: "black", label: "Schwarz / Black", css: "#000000" },
    ];

    const baseColors = colorOptions.map(o => o.label);

    /********** Expected quantities per type / Erwartete Mengen **********/
    const defaultQuantities = {
      "Accessoires & Ausr√ºstung": {
        "Socken": 84,
        "Handschuhe": 10,
        "M√ºtze/Schal": 16,
        "Handyhalter": 3,
        "Karateg√ºrtel": 3,
        "Taschen": 2,
        "Judo": 3,
        "Cappy": 1
      },
      "Bekleidung": {
        "Schuhe": 120,
        "Gymnastik (Tops & Leggings)": 48,
        "Leibchen": 7,
        "Oberteile": 277,
        "Unterteile": 167,
        "Sport-BHs": 17,
        "Badeanz√ºge": 57,
        "Bikini": 54
      }
    };

    /********** English display names for item types / Englische Namen **********/
    const typeDisplayNames = {
      "Socken": "Socken / Socks",
      "Handschuhe": "Handschuhe / Gloves",
      "M√ºtze/Schal": "M√ºtze/Schal / Beanie & Scarf",
      "Handyhalter": "Handyhalter / Phone holder",
      "Karateg√ºrtel": "Karateg√ºrtel / Karate belt",
      "Taschen": "Taschen / Bags",
      "Judo": "Judo / Judo gear",
      "Cappy": "Cappy / Cap",
      "Schuhe": "Schuhe / Shoes",
      "Gymnastik (Tops & Leggings)": "Gymnastik (Tops & Leggings) / Gym (tops & leggings)",
      "Leibchen": "Leibchen / Training bib",
      "Oberteile": "Oberteile / Tops",
      "Unterteile": "Unterteile / Bottoms",
      "Sport-BHs": "Sport-BHs / Sports bras",
      "Badeanz√ºge": "Badeanz√ºge / Swimsuits",
      "Bikini": "Bikini / Bikinis"
    };

    /********** Product templates / Produkt-Vorlagen **********/
    const productTemplates = {
      "Accessoires & Ausr√ºstung": {
        "Socken": {
          name: "Sportsocken / Sports socks",
          description: "Bequeme Sportsocken mit guter D√§mpfung. / Comfortable sports socks with good cushioning.",
          subcategory: "Accessoires / Accessories",
          type: "Socken / Socks",
          material: "Baumwolle-Polyester / Cotton-Polyester",
          colors: [...baseColors],
        },
        "Handschuhe": {
          name: "Sporthandschuhe / Sports gloves",
          description: "Handschuhe mit Grip f√ºr Training und Outdoor. / Gloves with grip for training and outdoor.",
          subcategory: "Accessoires / Accessories",
          type: "Handschuhe / Gloves",
          material: "Synthetik / Synthetic",
          colors: [...baseColors],
        },
        "M√ºtze/Schal": {
          name: "M√ºtze / Schal / Beanie / Scarf",
          description: "Warme M√ºtze oder Schal f√ºr Outdoor-Sport. / Warm beanie or scarf for outdoor sports.",
          subcategory: "Accessoires / Accessories",
          type: "M√ºtze/Schal / Beanie/Scarf",
          material: "Acryl / Acrylic",
          colors: [...baseColors],
        },
        "Handyhalter": {
          name: "Handyhalter / Phone holder",
          description: "Handyhalter f√ºr den Arm beim Laufen. / Phone holder for the arm while running.",
          subcategory: "Ausr√ºstung / Equipment",
          type: "Handyhalter / Phone holder",
          material: "Neopren / Neoprene",
          colors: [...baseColors],
        },
        "Karateg√ºrtel": {
          name: "Karateg√ºrtel / Karate belt",
          description: "Robuster G√ºrtel f√ºr Karate und andere Kampfsportarten. / Robust belt for karate and other martial arts.",
          subcategory: "Ausr√ºstung / Equipment",
          type: "Karateg√ºrtel / Karate belt",
          material: "Baumwolle / Cotton",
          colors: [...baseColors],
        },
        "Taschen": {
          name: "Sporttasche / Sports bag",
          description: "Ger√§umige Tasche f√ºr Sportausr√ºstung. / Spacious bag for sports equipment.",
          subcategory: "Ausr√ºstung / Equipment",
          type: "Tasche / Bag",
          material: "Polyester",
          colors: [...baseColors],
        },
        "Judo": {
          name: "Judo-Ausr√ºstung / Judo equipment",
          description: "Zubeh√∂r f√ºr Judo-Training und Wettkampf. / Accessories for judo training and competition.",
          subcategory: "Ausr√ºstung / Equipment",
          type: "Judo",
          material: "Mischgewebe / Mixed fabric",
          colors: [...baseColors],
        },
        "Cappy": {
          name: "Cap / Cappy",
          description: "Leichte Cap zum Sport oder Alltag. / Lightweight cap for sports or everyday use.",
          subcategory: "Accessoires / Accessories",
          type: "Cap / Cappy",
          material: "Baumwolle / Cotton",
          colors: [...baseColors],
        }
      },
      "Bekleidung": {
        "Schuhe": {
          name: "Sportschuhe / Sports shoes",
          description: "Leichte, bequeme Sportschuhe f√ºr Training und Alltag. / Lightweight, comfortable sports shoes for training and everyday use.",
          subcategory: "Schuhe / Shoes",
          type: "Schuhe / Shoes",
          material: "Synthetik / Synthetic",
          colors: [...baseColors],
        },
        "Gymnastik (Tops & Leggings)": {
          name: "Gymnastik-Outfit / Gym outfit",
          description: "Set aus Gymnastik-Top und Leggings. / Set of gym top and leggings.",
          subcategory: "Gymnastik / Gymnastics",
          type: "Tops & Leggings",
          material: "Elasthan-Mischung / Elastane blend",
          colors: [...baseColors],
        },
        "Leibchen": {
          name: "Leibchen / Training bib",
          description: "Standard-Leibchen f√ºr Training und Teamsport. / Standard training bib for practice and team sports.",
          subcategory: "Oberteile / Tops",
          type: "Leibchen / Bib",
          material: "Polyester",
          colors: [...baseColors],
        },
        "Oberteile": {
          name: "Sport-Oberteil / Sports top",
          description: "Oberteil f√ºr verschiedene Sportarten. / Top for various sports.",
          subcategory: "Oberteile / Tops",
          type: "Oberteil / Top",
          material: "Polyester",
          colors: [...baseColors],
        },
        "Unterteile": {
          name: "Sport-Unterteil / Sports bottom",
          description: "Bequeme Hose/Shorts f√ºr Sport und Training. / Comfortable pants/shorts for sports and training.",
          subcategory: "Unterteile / Bottoms",
          type: "Unterteil / Bottom",
          material: "Polyester",
          colors: [...baseColors],
        },
        "Sport-BHs": {
          name: "Sport-BH / Sports bra",
          description: "St√ºtzender Sport-BH f√ºr Training und Alltag. / Supportive sports bra for training and daily wear.",
          subcategory: "Unterw√§sche / Underwear",
          type: "Sport-BH / Sports bra",
          material: "Elasthan-Mischung / Elastane blend",
          colors: [...baseColors],
        },
        "Badeanz√ºge": {
          name: "Badeanzug / Swimsuit",
          description: "Sportlicher Badeanzug f√ºr Schwimmtraining. / Sporty swimsuit for swim training.",
          subcategory: "Schwimmen / Swim",
          type: "Badeanzug / Swimsuit",
          material: "Polyamid-Elasthan / Polyamide-elastane",
          colors: [...baseColors],
        },
        "Bikini": {
          name: "Bikini",
          description: "Sportlicher Bikini f√ºr Strand und Schwimmbad. / Sporty bikini for beach and pool.",
          subcategory: "Schwimmen / Swim",
          type: "Bikini",
          material: "Polyamid-Elasthan / Polyamide-elastane",
          colors: [...baseColors],
        }
      }
    };

    const categorySelect = document.getElementById('categorySelect');
    const itemTypeSelect = document.getElementById('itemTypeSelect');
    const quantityInput = document.getElementById('quantityInput');
    const skuInput = document.getElementById('skuInput');
    const sizeInput = document.getElementById('sizeInput');
    const imageUrlInput = document.getElementById('imageUrlInput');
    const jsonOutput = document.getElementById('jsonOutput');
    const saveAllBtn = document.getElementById('saveAllBtn');
    const backBtn = document.getElementById('backBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const colorButtonsContainer = document.getElementById('colorButtonsContainer');

    let skuDirty = false;

    /********** Top buttons **********/
    backBtn.addEventListener('click', () => {
      if (window.history.length > 1) {
        window.history.back();
      } else {
        location.reload();
      }
    });

    refreshBtn.addEventListener('click', () => {
      location.reload();
    });

    /********** Colour buttons **********/
    function setColorButtonVisualState(btn, selected) {
      const css = btn.dataset.colorCss;
      if (selected) {
        btn.style.backgroundColor = css;
        btn.style.borderColor = css;
        const cssLower = css.toLowerCase();
        // Dark text on very light colours, white on others
        if (cssLower === "#ffffff" || cssLower === "#eab308") {
          btn.style.color = "#111827";
        } else {
          btn.style.color = "#ffffff";
        }
      } else {
        btn.style.backgroundColor = "#f3f4f6";
        btn.style.borderColor = "#d1d5db";
        btn.style.color = "#111827";
      }
    }

    function initColorButtons() {
      colorButtonsContainer.innerHTML = "";
      colorOptions.forEach(opt => {
        const btn = document.createElement('button');
        btn.type = "button";
        btn.className = "color-btn";
        btn.textContent = opt.label;
        btn.dataset.colorLabel = opt.label;
        btn.dataset.colorCss = opt.css;
        setColorButtonVisualState(btn, false);
        btn.addEventListener('click', () => {
          const willSelect = !btn.classList.contains('selected');
          btn.classList.toggle('selected', willSelect);
          setColorButtonVisualState(btn, willSelect);
        });
        colorButtonsContainer.appendChild(btn);
      });
    }

    function getSelectedColors() {
      return Array.from(document.querySelectorAll('.color-btn.selected'))
        .map(btn => btn.dataset.colorLabel);
    }

    /********** Dropdown population & defaults **********/
    function populateItemTypes(category) {
      itemTypeSelect.innerHTML = '';
      if (!category || !productTemplates[category]) {
        itemTypeSelect.disabled = true;
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Choose category first / Bitte zuerst Kategorie w√§hlen ...';
        itemTypeSelect.appendChild(opt);
        return;
      }
      itemTypeSelect.disabled = false;
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Choose item type / Bitte Artikeltyp w√§hlen ...';
      itemTypeSelect.appendChild(placeholder);

      const types = Object.keys(productTemplates[category]);
      types.forEach(typeName => {
        const opt = document.createElement('option');
        opt.value = typeName;
        opt.textContent = typeDisplayNames[typeName] || typeName;
        itemTypeSelect.appendChild(opt);
      });
    }

    function applyDefaultQuantity(category, itemType) {
      const def = defaultQuantities[category] && defaultQuantities[category][itemType];
      if (typeof def !== "undefined") {
        quantityInput.value = def;
      } else if (!quantityInput.value) {
        quantityInput.value = "";
      }
    }

    function applyDefaultSize(category, itemType) {
      // Try to use EU-like suggestions where it makes sense
      if (category === "Bekleidung" && itemType === "Schuhe") {
        sizeInput.value = "42 (EU)";
      } else if (category === "Bekleidung") {
        sizeInput.value = "M (EU)";
      } else {
        sizeInput.value = "OneSize";
      }
    }

    function generateSku(category, itemType) {
      const prefixMap = {
        "Accessoires & Ausr√ºstung": "ACC",
        "Bekleidung": "BEK"
      };
      const prefix = prefixMap[category] || "GEN";
      const typePart = (itemType || "PROD")
        .toUpperCase()
        .replace(/√Ñ/g, "AE")
        .replace(/√ñ/g, "OE")
        .replace(/√ú/g, "UE")
        .replace(/√ü/g, "SS")
        .replace(/[^A-Z0-9]+/g, '-');
      // 5 random digits at the end
      const random = Math.floor(10000 + Math.random() * 90000); // 10000-99999
      return `${prefix}-${typePart}-${random}`;
    }

    categorySelect.addEventListener('change', () => {
      const category = categorySelect.value;
      populateItemTypes(category);
      if (!skuDirty && category) {
        skuInput.value = generateSku(category, itemTypeSelect.value || "PROD");
      }
      quantityInput.value = "";
      sizeInput.value = "";
    });

    itemTypeSelect.addEventListener('change', () => {
      const category = categorySelect.value;
      const itemType = itemTypeSelect.value;
      if (!skuDirty && category && itemType) {
        skuInput.value = generateSku(category, itemType);
      }
      if (category && itemType) {
        applyDefaultQuantity(category, itemType);
        applyDefaultSize(category, itemType);
      }
    });

    skuInput.addEventListener('input', () => {
      skuDirty = skuInput.value.trim().length > 0;
    });

    /********** Camera logic / Kamera-Logik **********/
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startCamBtn = document.getElementById('startCamBtn');
    const captureBtn = document.getElementById('captureBtn');
    const photoPreview = document.getElementById('photoPreview');

    let mediaStream = null;
    let capturedImageBlob = null;

    async function startCameraWithBackFacing() {
      const envConstraints = {
        video: {
          facingMode: { ideal: "environment" }
        },
        audio: false
      };
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia(envConstraints);
        return;
      } catch (err) {
        console.warn("Environment camera failed, falling back to default:", err);
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      }
    }

    startCamBtn.addEventListener('click', async () => {
      try {
        if (mediaStream) {
        mediaStream.getTracks().forEach(t => t.stop());
        }
        await startCameraWithBackFacing();
        video.srcObject = mediaStream;
        captureBtn.disabled = false;
      } catch (err) {
        alert('Camera could not be started: ' + err.message + '\nKamera konnte nicht gestartet werden: ' + err.message);
      }
    });

    function captureFrame(onSuccess) {
      if (!mediaStream) {
        alert('Please start the camera first.\nBitte zuerst die Kamera starten.');
        return;
      }
      const videoTrack = mediaStream.getVideoTracks()[0];
      const settings = videoTrack.getSettings();
      const width = settings.width || 640;
      const height = settings.height || 480;

      canvas.width = width;
      canvas.height = height;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, width, height);

      canvas.toBlob((blob) => {
        if (!blob) {
          alert('Error creating image.\nFehler beim Erzeugen des Bildes.');
          return;
        }
        onSuccess(blob);
      }, 'image/png');
    }

    // Optional preview-only button
    captureBtn.addEventListener('click', () => {
      captureFrame((blob) => {
        capturedImageBlob = blob;
        const url = URL.createObjectURL(blob);
        photoPreview.src = url;
        alert('Preview updated.\nVorschau aktualisiert.');
      });
    });

    function advanceToNextItemType() {
      const options = itemTypeSelect.options;
      const currentIndex = itemTypeSelect.selectedIndex;
      if (currentIndex > 0 && currentIndex < options.length - 1) {
        itemTypeSelect.selectedIndex = currentIndex + 1;
        itemTypeSelect.dispatchEvent(new Event('change'));
      } else {
        // last type, stay on it
      }
    }

    /********** Save JSON + photo (single click) **********/
    saveAllBtn.addEventListener('click', () => {
      const category = categorySelect.value;
      const itemType = itemTypeSelect.value;

      if (!category) {
        alert('Please select a category.\nBitte eine Kategorie w√§hlen.');
        return;
      }
      if (!itemType) {
        alert('Please select an item type.\nBitte einen Artikeltyp w√§hlen.');
        return;
      }

      let sku = skuInput.value.trim();
      if (!sku) {
        sku = generateSku(category, itemType);
        skuInput.value = sku;
      }

      const qty = parseInt(quantityInput.value, 10);
      const finalQty = isNaN(qty) ? 0 : qty;

      const sizeValue = sizeInput.value.trim();
      const sizesArray = sizeValue ? [sizeValue] : ["OneSize"];

      const selectedColors = getSelectedColors();

      const sanitizedSku = sku.replace(/\s+/g, '-');
      const photoFileName = sanitizedSku + '.png';
      const imageUrl = photoFileName;
      imageUrlInput.value = imageUrl;

      const template = productTemplates[category][itemType] || {
        name: typeDisplayNames[itemType] || itemType,
        description: "",
        subcategory: category,
        type: typeDisplayNames[itemType] || itemType,
        material: "",
        colors: [...baseColors]
      };

      captureFrame((blob) => {
        capturedImageBlob = blob;

        const previewUrl = URL.createObjectURL(blob);
        photoPreview.src = previewUrl;

        const product = {
          sku: sku,
          name: template.name,
          description: template.description,
          category: category,
          subcategory: template.subcategory,
          type: template.type,
          material: template.material,
          colors: selectedColors.length ? selectedColors : template.colors,
          sizes: sizesArray,
          stock: {
            "OneSize": finalQty
          },
          image_url: imageUrl
        };

        const jsonString = JSON.stringify([product], null, 2);
        if (jsonOutput) {
          jsonOutput.value = jsonString;
        }

        // Save JSON
        const jsonBlob = new Blob([jsonString], { type: 'application/json' });
        const jsonUrl = URL.createObjectURL(jsonBlob);
        const jsonLink = document.createElement('a');
        jsonLink.href = jsonUrl;
        jsonLink.download = sanitizedSku + '.json';
        document.body.appendChild(jsonLink);
        jsonLink.click();
        document.body.removeChild(jsonLink);
        URL.revokeObjectURL(jsonUrl);

        // Save image
        const imgUrl = URL.createObjectURL(capturedImageBlob);
        const imgLink = document.createElement('a');
        imgLink.href = imgUrl;
        imgLink.download = photoFileName;
        document.body.appendChild(imgLink);
        imgLink.click();
        document.body.removeChild(imgLink);
        URL.revokeObjectURL(imgUrl);

        // Auto-jump to next type
        advanceToNextItemType();
      });
    });

    /********** Init defaults: start with Clothing -> Shoes **********/
    function initDefaults() {
      // Init colour buttons
      initColorButtons();

      // Default category: Bekleidung
      let clothingIndex = -1;
      for (let i = 0; i < categorySelect.options.length; i++) {
        if (categorySelect.options[i].value === "Bekleidung") {
          clothingIndex = i;
          break;
        }
      }
      if (clothingIndex !== -1) {
        categorySelect.selectedIndex = clothingIndex;
        categorySelect.dispatchEvent(new Event('change'));
      }

      // After types are populated, choose "Schuhe"
      setTimeout(() => {
        let shoesIndex = -1;
        for (let i = 0; i < itemTypeSelect.options.length; i++) {
          if (itemTypeSelect.options[i].value === "Schuhe") {
            shoesIndex = i;
            break;
          }
        }
        if (shoesIndex !== -1) {
          itemTypeSelect.selectedIndex = shoesIndex;
          itemTypeSelect.dispatchEvent(new Event('change'));
        }
      }, 0);
    }

    // Run init
    initDefaults();
  </script>
</body>
</html>
