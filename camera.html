<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Produkt-Foto & JSON (One Button)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --primary: #1f2933;
      --primary-text: #ffffff;
      --border: #d0d7de;
      --bg-soft: #f7f9fb;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 12px;
      background: var(--bg-soft);
    }

    main {
      max-width: 900px;
      margin: 0 auto 40px;
    }

    h1 {
      margin: 0 0 0.25rem;
      font-size: 1.4rem;
      text-align: center;
    }

    p.lead {
      margin: 0 0 1rem;
      font-size: 0.9rem;
      text-align: center;
      color: #4b5563;
    }

    section {
      margin-top: 1rem;
      padding: 1rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #ffffff;
      box-shadow: 0 2px 4px rgba(15, 23, 42, 0.06);
    }

    h2 {
      margin-top: 0;
      font-size: 1.1rem;
    }

    #video, #photoPreview {
      width: 100%;
      max-height: 280px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      object-fit: cover;
      background: #000;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .row {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .field {
      margin-bottom: 0.75rem;
      flex: 1 1 100%;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
    }

    select,
    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 0.6rem 0.7rem;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 1rem; /* verhindert iOS-Zoom */
      background: #f9fafb;
    }

    textarea {
      font-family: "JetBrains Mono", "Fira Code", monospace;
      resize: vertical;
    }

    button {
      padding: 0.8rem 1rem;
      border-radius: 999px;
      border: none;
      background: var(--primary);
      color: var(--primary-text);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      width: 100%; /* big tappable buttons */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
    }

    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    small {
      display: block;
      color: #6b7280;
      margin-top: 0.25rem;
      font-size: 0.75rem;
    }

    #jsonOutput {
      width: 100%;
      padding: 0.6rem 0.7rem;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.8rem;
      background: #0b1020;
      color: #e5e7eb;
      min-height: 220px;
    }

    @media (min-width: 640px) {
      .row .field {
        flex: 1 1 calc(50% - 0.5rem);
      }

      button {
        width: auto; /* on larger screens, buttons shrink */
      }

      .controls {
        flex-direction: row;
        justify-content: space-between;
      }

      .controls button {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <main>
    <h1>Produkt-Foto & JSON</h1>
    <p class="lead">
      Kategorie & Artikeltyp wÃ¤hlen, Menge eintragen, Foto mit der RÃ¼ckkamera machen
      und mit einem Button Bild + JSON speichern.
    </p>

    <!-- Kamera / Foto -->
    <section>
      <h2>Kamera & Foto</h2>
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas" style="display:none;"></canvas>
      <div class="controls">
        <button id="startCamBtn">ðŸ“· Kamera (RÃ¼ckseite) starten</button>
        <button id="captureBtn" disabled>ðŸ“¸ Foto aufnehmen</button>
      </div>
      <small>
        Tipp: Auf dem Smartphone am besten Ã¼ber HTTPS Ã¶ffnen, sonst blocken manche Browser die Kamera.
      </small>
      <h3 style="margin-top: 0.9rem; font-size: 0.95rem;">Vorschau</h3>
      <img id="photoPreview" alt="Aufgenommenes Foto" />
    </section>

    <!-- Produkt-Auswahl (Dropdown) -->
    <section>
      <h2>Produkt-Auswahl</h2>
      <div class="row">
        <div class="field">
          <label for="categorySelect">Kategorie</label>
          <select id="categorySelect">
            <option value="">Bitte wÃ¤hlen ...</option>
            <option value="Accessoires & AusrÃ¼stung">Accessoires &amp; AusrÃ¼stung</option>
            <option value="Bekleidung">Bekleidung</option>
          </select>
        </div>

        <div class="field">
          <label for="itemTypeSelect">Artikeltyp</label>
          <select id="itemTypeSelect" disabled>
            <option value="">Bitte zuerst Kategorie wÃ¤hlen ...</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="quantityInput">Menge im Lager</label>
          <input type="number" id="quantityInput" min="0" step="1" placeholder="z.B. 84" />
          <small>Eine Gesamtmenge, intern als <code>OneSize</code> gespeichert.</small>
        </div>

        <div class="field">
          <label for="skuInput">SKU</label>
          <input type="text" id="skuInput" placeholder="wird automatisch erzeugt" />
          <small>Wird aus Kategorie + Artikeltyp erzeugt, kann aber Ã¼berschrieben werden.</small>
        </div>
      </div>

      <div class="field">
        <label for="imageUrlInput">image_url</label>
        <input type="text" id="imageUrlInput" placeholder="wird nach Fotoaufnahme auf &lt;SKU&gt;.png gesetzt" />
        <small>Dateiname des Bildes, optional mit Pfad/URL.</small>
      </div>

      <div class="controls">
        <button id="saveAllBtn">ðŸ’¾ Alles speichern (Foto + JSON)</button>
      </div>
    </section>

    <!-- JSON Ausgabe -->
    <section>
      <h2>JSON Vorschau</h2>
      <textarea id="jsonOutput" rows="16" readonly></textarea>
    </section>
  </main>

  <script>
    /********** Produkt-Vorlagen (Templates) **********/
    const productTemplates = {
      "Accessoires & AusrÃ¼stung": {
        "Socken": {
          name: "Sportsocken",
          description: "Bequeme Sportsocken mit guter DÃ¤mpfung.",
          subcategory: "Accessoires",
          type: "Socken",
          material: "Baumwolle-Polyester",
          colors: ["Schwarz", "WeiÃŸ"],
        },
        "Handschuhe": {
          name: "Sporthandschuhe",
          description: "Handschuhe mit Grip fÃ¼r Training und Outdoor.",
          subcategory: "Accessoires",
          type: "Handschuhe",
          material: "Synthetik",
          colors: ["Schwarz"],
        },
        "MÃ¼tze/Schal": {
          name: "MÃ¼tze / Schal",
          description: "Warme MÃ¼tze oder Schal fÃ¼r Outdoor-Sport.",
          subcategory: "Accessoires",
          type: "MÃ¼tze/Schal",
          material: "Acryl",
          colors: ["Schwarz", "Grau"],
        },
        "Handyhalter": {
          name: "Handyhalter",
          description: "Handyhalter fÃ¼r den Arm beim Laufen.",
          subcategory: "AusrÃ¼stung",
          type: "Handyhalter",
          material: "Neopren",
          colors: ["Schwarz"],
        },
        "KarategÃ¼rtel": {
          name: "KarategÃ¼rtel",
          description: "Robuster GÃ¼rtel fÃ¼r Karate und andere Kampfsportarten.",
          subcategory: "AusrÃ¼stung",
          type: "KarategÃ¼rtel",
          material: "Baumwolle",
          colors: ["WeiÃŸ", "Gelb", "Orange", "GrÃ¼n", "Blau", "Braun", "Schwarz"],
        },
        "Taschen": {
          name: "Sporttasche",
          description: "GerÃ¤umige Tasche fÃ¼r SportausrÃ¼stung.",
          subcategory: "AusrÃ¼stung",
          type: "Tasche",
          material: "Polyester",
          colors: ["Schwarz", "Blau"],
        },
        "Judo": {
          name: "Judo-AusrÃ¼stung",
          description: "ZubehÃ¶r fÃ¼r Judo-Training und Wettkampf.",
          subcategory: "AusrÃ¼stung",
          type: "Judo",
          material: "Mischgewebe",
          colors: ["WeiÃŸ"],
        },
        "Cappy": {
          name: "Cap",
          description: "Leichte Cap zum Sport oder Alltag.",
          subcategory: "Accessoires",
          type: "Cap",
          material: "Baumwolle",
          colors: ["Schwarz", "Navy"],
        }
      },
      "Bekleidung": {
        "Schuhe": {
          name: "Sportschuhe",
          description: "Leichte, bequeme Sportschuhe fÃ¼r Training und Alltag.",
          subcategory: "Schuhe",
          type: "Schuhe",
          material: "Synthetik",
          colors: ["Schwarz", "WeiÃŸ"],
        },
        "Gymnastik (Tops & Leggings)": {
          name: "Gymnastik-Outfit",
          description: "Set aus Gymnastik-Top und Leggings.",
          subcategory: "Gymnastik",
          type: "Tops & Leggings",
          material: "Elasthan-Mischung",
          colors: ["Schwarz", "Lila", "Blau"],
        },
        "Leibchen": {
          name: "Leibchen",
          description: "Standard-Leibchen fÃ¼r Training und Teamsport.",
          subcategory: "Oberteile",
          type: "Leibchen",
          material: "Polyester",
          colors: ["Gelb", "Rot", "Blau"],
        },
        "Oberteile": {
          name: "Sport-Oberteil",
          description: "Oberteil fÃ¼r verschiedene Sportarten.",
          subcategory: "Oberteile",
          type: "Oberteil",
          material: "Polyester",
          colors: ["Schwarz", "Blau", "Rot"],
        },
        "Unterteile": {
          name: "Sport-Unterteil",
          description: "Bequeme Hose/Shorts fÃ¼r Sport und Training.",
          subcategory: "Unterteile",
          type: "Unterteil",
          material: "Polyester",
          colors: ["Schwarz", "Navy"],
        },
        "Sport-BHs": {
          name: "Sport-BH",
          description: "StÃ¼tzender Sport-BH fÃ¼r Training und Alltag.",
          subcategory: "UnterwÃ¤sche",
          type: "Sport-BH",
          material: "Elasthan-Mischung",
          colors: ["Schwarz", "Grau"],
        },
        "BadeanzÃ¼ge": {
          name: "Badeanzug",
          description: "Sportlicher Badeanzug fÃ¼r Schwimmtraining.",
          subcategory: "Schwimmen",
          type: "Badeanzug",
          material: "Polyamid-Elasthan",
          colors: ["Blau", "Schwarz"],
        },
        "Bikini": {
          name: "Bikini",
          description: "Sportlicher Bikini fÃ¼r Strand und Schwimmbad.",
          subcategory: "Schwimmen",
          type: "Bikini",
          material: "Polyamid-Elasthan",
          colors: ["Bunt", "Schwarz"],
        }
      }
    };

    const categorySelect = document.getElementById('categorySelect');
    const itemTypeSelect = document.getElementById('itemTypeSelect');
    const quantityInput = document.getElementById('quantityInput');
    const skuInput = document.getElementById('skuInput');
    const imageUrlInput = document.getElementById('imageUrlInput');
    const jsonOutput = document.getElementById('jsonOutput');
    const saveAllBtn = document.getElementById('saveAllBtn');

    let skuDirty = false;

    function populateItemTypes(category) {
      itemTypeSelect.innerHTML = '';
      if (!category || !productTemplates[category]) {
        itemTypeSelect.disabled = true;
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Bitte zuerst Kategorie wÃ¤hlen ...';
        itemTypeSelect.appendChild(opt);
        return;
      }
      itemTypeSelect.disabled = false;
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Bitte Artikeltyp wÃ¤hlen ...';
      itemTypeSelect.appendChild(placeholder);

      const types = Object.keys(productTemplates[category]);
      types.forEach(typeName => {
        const opt = document.createElement('option');
        opt.value = typeName;
        opt.textContent = typeName;
        itemTypeSelect.appendChild(opt);
      });
    }

    function generateSku(category, itemType) {
      const prefixMap = {
        "Accessoires & AusrÃ¼stung": "ACC",
        "Bekleidung": "BEK"
      };
      const prefix = prefixMap[category] || "GEN";
      const typePart = (itemType || "PROD")
        .toUpperCase()
        .replace(/Ã„/g, "AE")
        .replace(/Ã–/g, "OE")
        .replace(/Ãœ/g, "UE")
        .replace(/ÃŸ/g, "SS")
        .replace(/[^A-Z0-9]+/g, '-');
      const random = Math.floor(100 + Math.random() * 900);
      return `${prefix}-${typePart}-${random}`;
    }

    categorySelect.addEventListener('change', () => {
      populateItemTypes(categorySelect.value);
      if (!skuDirty && categorySelect.value) {
        skuInput.value = generateSku(categorySelect.value, itemTypeSelect.value || "PROD");
      }
    });

    itemTypeSelect.addEventListener('change', () => {
      if (!skuDirty && categorySelect.value && itemTypeSelect.value) {
        skuInput.value = generateSku(categorySelect.value, itemTypeSelect.value);
      }
    });

    skuInput.addEventListener('input', () => {
      skuDirty = skuInput.value.trim().length > 0;
    });

    /********** Kamera-Logik (Back Camera bevorzugt) **********/
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startCamBtn = document.getElementById('startCamBtn');
    const captureBtn = document.getElementById('captureBtn');
    const photoPreview = document.getElementById('photoPreview');

    let mediaStream = null;
    let capturedImageBlob = null;
    let capturedImageFilename = null;

    async function startCameraWithBackFacing() {
      const envConstraints = {
        video: {
          facingMode: { ideal: "environment" }
        },
        audio: false
      };
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia(envConstraints);
        return;
      } catch (err) {
        console.warn("Environment camera failed, falling back to default:", err);
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      }
    }

    startCamBtn.addEventListener('click', async () => {
      try {
        if (mediaStream) {
          mediaStream.getTracks().forEach(t => t.stop());
        }
        await startCameraWithBackFacing();
        video.srcObject = mediaStream;
        captureBtn.disabled = false;
      } catch (err) {
        alert('Kamera konnte nicht gestartet werden: ' + err.message);
      }
    });

    // Foto aufnehmen
    captureBtn.addEventListener('click', () => {
      if (!mediaStream) {
        alert('Bitte zuerst die Kamera starten.');
        return;
      }

      const videoTrack = mediaStream.getVideoTracks()[0];
      const settings = videoTrack.getSettings();
      const width = settings.width || 640;
      const height = settings.height || 480;

      canvas.width = width;
      canvas.height = height;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, width, height);

      canvas.toBlob((blob) => {
        if (!blob) {
          alert('Fehler beim Erzeugen des Bildes.');
          return;
        }
        capturedImageBlob = blob;

        const skuVal = (skuInput.value || 'produkt-foto').trim().replace(/\s+/g, '-');
        capturedImageFilename = skuVal + '.png';

        const url = URL.createObjectURL(blob);
        photoPreview.src = url;

        imageUrlInput.value = capturedImageFilename;

        alert('Foto aufgenommen! Beim Speichern wird dieses Bild verwendet.');
      }, 'image/png');
    });

    /********** JSON + Bild speichern (ein Button) **********/
    saveAllBtn.addEventListener('click', () => {
      const category = categorySelect.value;
      const itemType = itemTypeSelect.value;

      if (!category) {
        alert('Bitte eine Kategorie wÃ¤hlen.');
        return;
      }
      if (!itemType) {
        alert('Bitte einen Artikeltyp wÃ¤hlen.');
        return;
      }

      const qty = parseInt(quantityInput.value, 10) || 0;
      let sku = skuInput.value.trim();
      if (!sku) {
        sku = generateSku(category, itemType);
        skuInput.value = sku;
      }

      // sicherstellen, dass ein Foto existiert
      if (!capturedImageBlob) {
        alert('Bitte zuerst ein Foto aufnehmen, bevor du speicherst.');
        return;
      }

      // Bild-Dateiname & image_url
      capturedImageFilename = sku.replace(/\s+/g, '-') + '.png';
      let imageUrl = imageUrlInput.value.trim();
      if (!imageUrl) {
        imageUrl = capturedImageFilename;
        imageUrlInput.value = imageUrl;
      }

      const template = productTemplates[category][itemType] || {
        name: itemType,
        description: "",
        subcategory: category,
        type: itemType,
        material: "",
        colors: []
      };

      const product = {
        sku: sku,
        name: template.name,
        description: template.description,
        category: category,
        subcategory: template.subcategory,
        type: template.type,
        material: template.material,
        colors: template.colors,
        sizes: ["OneSize"],
        stock: {
          "OneSize": qty
        },
        image_url: imageUrl
      };

      const jsonString = JSON.stringify([product], null, 2);
      jsonOutput.value = jsonString;

      // JSON speichern
      const jsonBlob = new Blob([jsonString], { type: 'application/json' });
      const jsonUrl = URL.createObjectURL(jsonBlob);
      const jsonLink = document.createElement('a');
      jsonLink.href = jsonUrl;
      jsonLink.download = sku.replace(/\s+/g, '-') + '.json';
      document.body.appendChild(jsonLink);
      jsonLink.click();
      document.body.removeChild(jsonLink);
      URL.revokeObjectURL(jsonUrl);

      // Bild speichern
      const imgUrl = URL.createObjectURL(capturedImageBlob);
      const imgLink = document.createElement('a');
      imgLink.href = imgUrl;
      imgLink.download = capturedImageFilename;
      document.body.appendChild(imgLink);
      imgLink.click();
      document.body.removeChild(imgLink);
      URL.revokeObjectURL(imgUrl);
    });
  </script>
</body>
</html>
